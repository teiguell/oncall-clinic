<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OnCall Clinic - Doctor Portal</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, sans-serif; background: #f8fafc; }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        .login-card { max-width: 400px; margin: 4rem auto; background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 2rem; }
        .dashboard { display: none; }
        .logo { text-align: center; margin-bottom: 2rem; }
        .logo-text { font-size: 24px; font-weight: bold; color: #2563eb; }
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151; }
        .form-input { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px; }
        .form-input:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .btn { width: 100%; padding: 12px; background: #2563eb; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 500; cursor: pointer; }
        .btn:hover { background: #1d4ed8; }
        .btn:disabled { background: #9ca3af; cursor: not-allowed; }
        .error { color: #dc2626; margin-top: 0.5rem; font-size: 14px; }
        .success { color: #059669; margin-top: 0.5rem; font-size: 14px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-title { font-size: 14px; color: #6b7280; margin-bottom: 0.5rem; }
        .stat-value { font-size: 32px; font-weight: bold; color: #111827; }
        .appointments-section { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1.5rem; }
        .section-title { font-size: 18px; font-weight: 600; margin-bottom: 1rem; color: #111827; }
        .appointment-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid #e5e7eb; }
        .appointment-item:last-child { border-bottom: none; }
        .patient-info { flex: 1; }
        .patient-name { font-weight: 500; color: #111827; }
        .appointment-time { font-size: 14px; color: #6b7280; }
        .appointment-status { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 12px; font-weight: 500; }
        .status-confirmed { background: #dcfce7; color: #166534; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-completed { background: #dbeafe; color: #1e40af; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .doctor-name { font-size: 24px; font-weight: bold; color: #111827; }
        .logout-btn { background: #6b7280; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; }
        .logout-btn:hover { background: #4b5563; }
        .nav-tabs { display: flex; border-bottom: 1px solid #e5e7eb; margin-bottom: 2rem; }
        .nav-tab { padding: 1rem 2rem; background: none; border: none; color: #6b7280; cursor: pointer; font-weight: 500; }
        .nav-tab.active { color: #2563eb; border-bottom: 2px solid #2563eb; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; }
        .availability-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1rem; margin-bottom: 1rem; }
        .day-card { background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; text-align: center; }
        .day-card.available { border-color: #10b981; background: #f0fdf4; }
        .chat-section { background: white; border-radius: 8px; padding: 1rem; height: 400px; display: flex; flex-direction: column; }
        .chat-messages { flex: 1; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 4px; padding: 1rem; margin-bottom: 1rem; }
        .chat-input { display: flex; gap: 0.5rem; }
        .file-upload { margin-bottom: 1rem; }
        .file-upload input { display: none; }
        .file-upload label { display: inline-block; padding: 8px 16px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 4px; cursor: pointer; }
        .booking-card { background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; }
        .booking-active { background: #dcfce7; border-color: #10b981; }
    </style>
</head>
<body>
    <!-- Login Form -->
    <div id="login-section" class="login-card">
        <div class="logo">
            <div class="logo-text">OnCall Clinic - Doctor Portal</div>
        </div>
        <form id="login-form">
            <div class="form-group">
                <label class="form-label" for="email">Email</label>
                <input type="email" id="email" class="form-input" placeholder="doctortest@oncall.clinic" required>
            </div>
            <div class="form-group">
                <label class="form-label" for="password">Password</label>
                <input type="password" id="password" class="form-input" placeholder="pepe" required>
            </div>
            <button type="submit" id="login-btn" class="btn">Sign In</button>
            <div id="login-message"></div>
            
            <div style="text-align: center; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e5e7eb;">
                <p style="color: #6b7280; margin-bottom: 1rem;">New doctor?</p>
                <a href="/doctor/register" style="color: #2563eb; text-decoration: none; font-weight: 600;">Register here</a>
            </div>
        </form>
    </div>

    <!-- Dashboard -->
    <div id="dashboard-section" class="dashboard container">
        <div class="header">
            <div class="doctor-name" id="doctor-name">Dr. Loading...</div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('overview')">Overview</button>
            <button class="nav-tab" onclick="showTab('availability')">Availability</button>
            <button class="nav-tab" onclick="showTab('bookings')">Current Bookings</button>
            <button class="nav-tab" onclick="showTab('chat')">Patient Chat</button>
            <button class="nav-tab" onclick="showTab('settings')">Settings</button>
        </div>

        <!-- Overview Tab -->
        <div id="overview-tab" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-title">Today's Appointments</div>
                    <div class="stat-value" id="today-appointments">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">This Week</div>
                    <div class="stat-value" id="week-appointments">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Total Appointments</div>
                    <div class="stat-value" id="total-appointments">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Average Rating</div>
                    <div class="stat-value" id="average-rating">0.0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Total Earnings</div>
                    <div class="stat-value" id="total-earnings">€0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Pending Earnings</div>
                    <div class="stat-value" id="pending-earnings">€0</div>
                </div>
            </div>

            <div class="appointments-section">
                <div class="section-title">Recent Appointments</div>
                <div id="appointments-list">
                    <div style="text-align: center; color: #6b7280; padding: 2rem;">
                        No appointments yet
                    </div>
                </div>
            </div>
        </div>

        <!-- Availability Tab -->
        <div id="availability-tab" class="tab-content">
            <div class="section-title">Weekly Availability</div>
            <div class="availability-grid" id="availability-grid">
                <!-- Days will be populated by JavaScript -->
            </div>
            <button class="btn" onclick="saveAvailability()">Save Availability</button>
        </div>

        <!-- Current Bookings Tab -->
        <div id="bookings-tab" class="tab-content">
            <div class="section-title">Active Bookings</div>
            <div id="active-bookings">
                <div class="booking-card booking-active">
                    <h3>No active bookings</h3>
                    <p>When you have an active booking, it will appear here with patient details and location.</p>
                </div>
            </div>
        </div>

        <!-- Chat Tab -->
        <div id="chat-tab" class="tab-content">
            <div class="section-title">Patient Communication</div>
            <div class="chat-section">
                <div class="chat-messages" id="chat-messages">
                    <div style="text-align: center; color: #6b7280; padding: 2rem;">
                        No active conversations
                    </div>
                </div>
                <div class="chat-input">
                    <input type="text" id="chat-input" class="form-input" placeholder="Type your message..." style="flex: 1;">
                    <button class="btn" onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content">
            <div class="section-title">Doctor Settings</div>
            <div class="form-grid">
                <div class="stat-card">
                    <div class="section-title">IBAN for Payments</div>
                    <div class="form-group">
                        <label class="form-label">Bank Account (IBAN)</label>
                        <input type="text" id="iban-input" class="form-input" placeholder="ES12 3456 7890 1234 5678 9012">
                    </div>
                    <button class="btn" onclick="saveIban()">Update IBAN</button>
                </div>
                
                <div class="stat-card">
                    <div class="section-title">Service Area</div>
                    <div class="form-group">
                        <label class="form-label">Maximum Distance (km)</label>
                        <input type="number" id="max-distance" class="form-input" value="30" min="5" max="50">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Base Price (EUR)</label>
                        <input type="number" id="base-price" class="form-input" value="80" min="50" max="200">
                    </div>
                    <button class="btn" onclick="saveServiceArea()">Update Settings</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;

        // Login form submission
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('login-btn');
            const messageDiv = document.getElementById('login-message');
            
            loginBtn.disabled = true;
            loginBtn.textContent = 'Signing in...';
            messageDiv.innerHTML = '';
            
            try {
                const response = await fetch('/api/doctor/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentUser = data.user;
                    messageDiv.innerHTML = '<div class="success">Login successful!</div>';
                    
                    // Hide login, show dashboard
                    document.getElementById('login-section').style.display = 'none';
                    document.getElementById('dashboard-section').style.display = 'block';
                    
                    // Load dashboard data
                    loadDashboard();
                } else {
                    messageDiv.innerHTML = '<div class="error">' + data.message + '</div>';
                }
            } catch (error) {
                messageDiv.innerHTML = '<div class="error">Connection error. Please try again.</div>';
            }
            
            loginBtn.disabled = false;
            loginBtn.textContent = 'Sign In';
        });

        // Load dashboard data
        async function loadDashboard() {
            try {
                const response = await fetch('/api/doctor/dashboard');
                const data = await response.json();
                
                if (data.success) {
                    // Update doctor name
                    document.getElementById('doctor-name').textContent = 
                        currentUser.firstName + ' ' + currentUser.lastName;
                    
                    // Update stats
                    document.getElementById('today-appointments').textContent = data.stats.todayAppointments;
                    document.getElementById('week-appointments').textContent = data.stats.thisWeekAppointments;
                    document.getElementById('total-appointments').textContent = data.stats.totalAppointments;
                    document.getElementById('average-rating').textContent = data.stats.averageRating.toFixed(1);
                    document.getElementById('total-earnings').textContent = '€' + (data.stats.totalEarnings / 100).toFixed(2);
                    document.getElementById('pending-earnings').textContent = '€' + (data.stats.pendingEarnings / 100).toFixed(2);
                    
                    // Update appointments list
                    const appointmentsList = document.getElementById('appointments-list');
                    if (data.recentAppointments && data.recentAppointments.length > 0) {
                        let appointmentsHtml = '';
                        data.recentAppointments.forEach(apt => {
                            appointmentsHtml += '<div class="appointment-item">';
                            appointmentsHtml += '<div class="patient-info">';
                            appointmentsHtml += '<div class="patient-name">Patient #' + apt.patientId + '</div>';
                            appointmentsHtml += '<div class="appointment-time">' + new Date(apt.appointmentDate).toLocaleDateString() + ' ' + new Date(apt.appointmentDate).toLocaleTimeString() + '</div>';
                            appointmentsHtml += '</div>';
                            appointmentsHtml += '<span class="appointment-status status-' + apt.status.toLowerCase() + '">' + apt.status + '</span>';
                            appointmentsHtml += '</div>';
                        });
                        appointmentsList.innerHTML = appointmentsHtml;
                    } else {
                        appointmentsList.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 2rem;">No appointments yet</div>';
                    }
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        // Logout function
        function logout() {
            currentUser = null;
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('dashboard-section').style.display = 'none';
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
            document.getElementById('login-message').innerHTML = '';
        }

        // Tab management
        function showTab(tabName) {
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
            
            // Load specific tab data
            if (tabName === 'availability') {
                loadAvailability();
            } else if (tabName === 'bookings') {
                loadActiveBookings();
            } else if (tabName === 'settings') {
                loadSettings();
            }
        }

        // Load weekly availability
        function loadAvailability() {
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            
            const grid = document.getElementById('availability-grid');
            grid.innerHTML = '';
            
            days.forEach((day, index) => {
                const dayCard = document.createElement('div');
                dayCard.className = 'day-card';
                dayCard.innerHTML = `
                    <h4>${dayNames[index]}</h4>
                    <label>
                        <input type="checkbox" id="${day}-available" ${index < 5 ? 'checked' : ''}> Available
                    </label>
                    <div style="margin-top: 0.5rem;">
                        <input type="time" id="${day}-start" value="09:00" class="form-input" style="margin-bottom: 0.25rem;">
                        <input type="time" id="${day}-end" value="18:00" class="form-input">
                    </div>
                `;
                
                if (index < 5) {
                    dayCard.classList.add('available');
                }
                
                grid.appendChild(dayCard);
            });
        }

        // Save availability
        async function saveAvailability() {
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            const availability = {};
            
            days.forEach(day => {
                availability[day] = {
                    available: document.getElementById(day + '-available').checked,
                    startTime: document.getElementById(day + '-start').value,
                    endTime: document.getElementById(day + '-end').value
                };
            });
            
            try {
                const response = await fetch('/api/doctor/availability', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ weeklyAvailability: availability })
                });
                
                if (response.ok) {
                    alert('Availability updated successfully!');
                } else {
                    alert('Failed to update availability');
                }
            } catch (error) {
                alert('Error updating availability');
            }
        }

        // Load active bookings
        async function loadActiveBookings() {
            try {
                const response = await fetch('/api/doctor/active-bookings');
                const data = await response.json();
                
                const container = document.getElementById('active-bookings');
                if (data.success && data.bookings && data.bookings.length > 0) {
                    container.innerHTML = data.bookings.map(booking => `
                        <div class="booking-card booking-active">
                            <h3>Patient: ${booking.patientName || 'Patient #' + booking.patientId}</h3>
                            <p><strong>Date:</strong> ${new Date(booking.appointmentDate).toLocaleString()}</p>
                            <p><strong>Location:</strong> ${booking.location}</p>
                            <p><strong>Status:</strong> ${booking.status}</p>
                            <p><strong>Amount:</strong> €${(booking.amount / 100).toFixed(2)}</p>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `
                        <div class="booking-card">
                            <h3>No active bookings</h3>
                            <p>When you have an active booking, it will appear here with patient details and location.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading bookings:', error);
            }
        }

        // Load settings
        async function loadSettings() {
            try {
                const response = await fetch('/api/doctor/settings');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('iban-input').value = data.settings.bankAccount || '';
                    document.getElementById('max-distance').value = data.settings.maxDistance || 30;
                    document.getElementById('base-price').value = (data.settings.basePrice / 100) || 80;
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Save IBAN
        async function saveIban() {
            const iban = document.getElementById('iban-input').value;
            
            try {
                const response = await fetch('/api/doctor/iban', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bankAccount: iban })
                });
                
                if (response.ok) {
                    alert('IBAN updated successfully!');
                } else {
                    alert('Failed to update IBAN');
                }
            } catch (error) {
                alert('Error updating IBAN');
            }
        }

        // Save service area settings
        async function saveServiceArea() {
            const maxDistance = document.getElementById('max-distance').value;
            const basePrice = document.getElementById('base-price').value * 100; // Convert to cents
            
            try {
                const response = await fetch('/api/doctor/service-area', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ maxDistance: parseInt(maxDistance), basePrice: parseInt(basePrice) })
                });
                
                if (response.ok) {
                    alert('Service area settings updated successfully!');
                } else {
                    alert('Failed to update settings');
                }
            } catch (error) {
                alert('Error updating settings');
            }
        }

        // Send chat message
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            try {
                const response = await fetch('/api/doctor/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                
                if (response.ok) {
                    input.value = '';
                    loadChatMessages();
                }
            } catch (error) {
                alert('Error sending message');
            }
        }

        // Load chat messages
        async function loadChatMessages() {
            try {
                const response = await fetch('/api/doctor/chat');
                const data = await response.json();
                
                const container = document.getElementById('chat-messages');
                if (data.success && data.messages && data.messages.length > 0) {
                    container.innerHTML = data.messages.map(msg => `
                        <div style="margin-bottom: 1rem; padding: 0.5rem; background: ${msg.fromDoctor ? '#e0f2fe' : '#f3f4f6'}; border-radius: 4px;">
                            <strong>${msg.fromDoctor ? 'You' : 'Patient'}:</strong> ${msg.content}
                            <div style="font-size: 12px; color: #6b7280; margin-top: 0.25rem;">
                                ${new Date(msg.timestamp).toLocaleString()}
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 2rem;">No active conversations</div>';
                }
            } catch (error) {
                console.error('Error loading chat:', error);
            }
        }

        // Auto-refresh dashboard every 30 seconds
        setInterval(() => {
            if (currentUser) {
                loadDashboard();
                loadActiveBookings();
                loadChatMessages();
            }
        }, 30000);
    </script>
</body>
</html>